<beast version='2.0' 
	namespace='snap:beast.util:beast.core.util:beast.evolution:beast.evolution.alignment:snap.likelihood:beast.core.util:beast.evolution:beast.math.distributions:beast.app.beauti'>

    <beauticonfig spec='BeautiConfig'
        inputLabelMap='snap.MCMC.operator=Operators,
	        snap.MCMC.logger=Loggers,
            beast.evolution.sitemodel.SiteModel.substModel=,
            beast.core.parameter.RealParameter.estimate=Sample,
            beast.core.parameter.IntegerParameter.estimate=Sample,
            beast.core.parameter.BooleanParameter.estimate=Sample,
	        snap.MCMC.preBurnin=Burn in'
        inlinePlugins ='beast.core.MCMC.distribution,
	        snap.MCMC.distribution,
	        beast.core.MCMC.logger,
	        beast.evolution.sitemodel.SiteModel.substModel,
	        beast.evolution.tree.coalescent.ExponentialGrowth,
	        beast.evolution.tree.coalescent.ConstantPopulation,
	        beast.evolution.tree.coalescent.Coalescent'
        collapsedPlugins ='snap.MCMC.logger'
        suppressPlugins = 'snap.MCMC.operator,
	        snap.MCMC.state,
	        snap.MCMC.distribution,
	        snap.MCMC.stateDistribution,
	        snap.MCMC.init,
	        snap.MCMC.sampleFromPrior,
	        snap.likelihood.SnAPPrior.tree,
	        snap.likelihood.SnapSubstitutionModel.frequencies,
            beast.evolution.sitemodel.SiteModel.mutationRate,
            beast.evolution.sitemodel.SiteModel.gammaCategoryCount,
            beast.evolution.sitemodel.SiteModel.proportionInvariant,
	        beast.evolution.speciation.BirthDeathGernhard08Model.relativeDeathRate,
	        beast.evolution.speciation.BirthDeathGernhard08Model.treeIntervals,
	        beast.evolution.speciation.BirthDeathGernhard08Model.type,
	        beast.evolution.speciation.BirthDeathGernhard08Model.sampleProbability,
	        beast.evolution.speciation.BirthDeathGernhard08Model.tree,
	        beast.evolution.tree.Tree.trait,
	        beast.evolution.tree.Tree.nodetype,
	        beast.util.TreeParser.initial,
	        beast.util.TreeParser.taxa,
	        beast.util.TreeParser.trait,
	        beast.util.TreeParser.estimate,
	        beast.util.ClusterTree.initial,
	        beast.util.ClusterTree.taxa,
	        beast.util.ClusterTree.trait,
	        beast.util.ClusterTree.estimate,
            beast.math.distributions.Prior.x,
            beast.core.Logger.model,
            beast.core.Logger.mode'
        buttonLabelMap='beast.app.beauti.BeautiInitDlg.&gt;&gt; details=Edit parameters,
            beast.app.beauti.BeautiInitDlg.Create new specification=Import alignment(s),
            beast.app.beauti.BeautiInitDlg.Load existing file=Open SNAP xml file,
            beast.app.beauti.BeautiInitDlg.Beast file:=SNAP file:,
            beast.app.beauti.TaxonSetInputEditor.Guess taxon sets=Guess species,
            beast.app.beauti.Beauti.Taxon sets=Species,
            beast.app.beauti.Beauti.Site Model=Mutation Model
            '
        disableMenus='View.Show Data panel,View.Show Tip Dates panel,View.Show Clock Model panel,View.Show Tree prior panel,Mode'
    >

    	<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Taxon sets" tiptext="Taxon sets" 
            path='distribution/distribution[id="likelihood"]/distribution/data'
            hasPartitions="none" icon='2.png' forceExpansion='FALSE'
			type='snap.Data'
        />

    	<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Taxon sets2" tiptext="Taxon sets2" 
            path='distribution/distribution[id="likelihood"]/distribution/data/taxonset'
            hasPartitions="none" icon='1.png' forceExpansion='FALSE'
            isVisible='false'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Mutation Model" tiptext="Mutation model specification"
            path='distribution/distribution[id="likelihood"]/distribution/siteModel/substModel'
            hasPartitions="none" icon='3.png' forceExpansion='TRUE'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Prior" tiptext="Tree and parameter priors"
            path='distribution/distribution[id="prior"]/distribution'
            hasPartitions="none" icon='7.png' forceExpansion='TRUE'
            buttonStatus='NONE'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="Operators" tiptext="MCMC Operator details"
            path='operator'
            hasPartitions="none" icon='8.png' forceExpansion='FALSE'
            isVisible='false'
            buttonStatus='NONE'
        />
		<panel spec='beast.app.beauti.BeautiPanelConfig' panelname="MCMC" tiptext="MCMC parameters"
            path=''
            hasPartitions="none" icon='9.png' forceExpansion='TRUE'
        />


        <partitiontemplate id='xxx' spec='BeautiSubTemplate' class='beast.evolution.likelihood.TreeLikelihood' mainid='mcmc'>
<![CDATA[

        <data spec='snap.Data' id='snap.$(n)' dataType='integerdata'>
            <rawdata idref='$(n)'/>
        </data>

        <distribution spec='snap.likelihood.SnAPPrior' name='distribution' id='snapprior.$(n)' rateprior='gamma'>
			  <parameter name='alpha' id='alpha'  value='11.750' lower='0.0' estimate='false'/>
			  <parameter name='beta' id='beta'   value='109.73' lower='0.0' estimate='false'/>
			  <parameter name='lambda' id='lambda' value='0.00765' lower='0.0' estimate='false'/>
	          <parameter name='kappa' id='kappa' value='1.0' lower='0.0' estimate='false'/>
		      <tree spec='beast.util.ClusterTree' id='Tree.$(n)' nodetype='snap.NodeData' clusterType='upgma'>
		            <input name='taxa' idref='snap.$(n)'/>
		      </tree>
		      <parameter name='coalescenceRate' id='coalescenceRate' value='10'/>
        </distribution>
        <distribution id='alphaPrior.$(n)' spec='Prior' x='@alpha'><distr spec='OneOnX'/></distribution>
        <distribution id='betaPrior.$(n)' spec='Prior' x='@beta'><distr spec='OneOnX'/></distribution>
        <distribution id='lambdaPrior.$(n)' spec='Prior' x='@lambda'><distr spec='OneOnX'/></distribution>
        <distribution id='kappaPrior.$(n)' spec='Prior' x='@kappa'><distr spec='OneOnX'/></distribution>
        <distribution id='uPrior.$(n)' spec='Prior' x='@u'><distr spec='OneOnX'/></distribution>
        <distribution id='vPrior.$(n)' spec='Prior' x='@v'><distr spec='OneOnX'/></distribution>


         <snaptreelikelihood spec='snap.likelihood.SnAPTreeLikelihood' name='distribution' id='treeLikelihood.$(n)' initFromTree='false' pattern='coalescenceRate'>
            <siteModel spec='sitemodel.SiteModel' id="MutationSiteModel.$(n)">
                <parameter name='mutationRate' id='mutationRate' value='1.0' estimate='false'/>
                <parameter name='proportionInvariant' id='proportionInvariant' value='0.0' estimate='false'/>
                <parameter name='shape' value='2.0' id='shape' estimate='false'/>
                <substModel spec='snap.likelihood.SnapSubstitutionModel' id='MutationModel' coalescenceRate='@coalescenceRate'>
					  <parameter name='mutationRateV' id='v' value='0.588235' lower='0.0' estimate='false'/>
					  <parameter name='mutationRateU' id='u' value='3.33333' lower='0.0' estimate='false'/>
                </substModel>
            </siteModel>
            <data idref='snap.$(n)'/>
            <tree idref='Tree.$(n)'/>
        </snaptreelikelihood>


        <operator id='NodeSwapper' spec='snap.operators.NodeSwapper' weight='0.5' tree='@Tree.$(n)'/>
        <operator id='NodeBudger' spec='snap.operators.NodeBudger' weight='0.5' size='0.5' tree='@Tree.$(n)'/>
        <operator id='TreeScaler' spec='snap.operators.ScaleOperator' scaleFactor='0.25' weight='0.5' tree='@Tree.$(n)'/>
        <operator id='GammaMover' spec='snap.operators.GammaMover' scale='0.5' weight='8' coalescenceRate='@coalescenceRate'/>
        <operator id='RateMixer' spec='snap.operators.RateMixer' scaleFactors='0.25' weight='1' coalescenceRate='@coalescenceRate' tree='@Tree.$(n)' />

        <!--operator spec='operators.ScaleOperator' scaleFactor="0.75" weight="3" parameter='@birthRate'/-->


        <operator id='uScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@u'/>
        <operator id='vScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@v'/>

        <operator id='alphaScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@alpha'/>
        <operator id='betaScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@beta'/>
        <operator id='lambdaScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@lambda'/>
        <operator id='kappaScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@kappa'/>

        <operator id='mutationRateScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@mutationRate'/>
        <operator id='propInvariantScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@proportionInvariant'/>
        <operator id='gammaShapeScaler' spec='snap.operators.ScaleOperator' scaleFactor="0.75" weight="1" parameter='@shape'/>


        <log id='ThetaLogger' spec='snap.ThetaLogger' coalescenceRate='@coalescenceRate'/>
        <log id='TreeHeightLogger' spec='beast.evolution.tree.TreeHeightLogger' tree='@Tree.$(n)'/>

        <logger spec='Logger' logEvery='100' fileName='snap.$(seed).trees' mode='tree'  id='treelog'>  
	        <log id='TreeWithMetaDataLogger.$(n)' spec='beast.evolution.tree.TreeWithMetaDataLogger' tree='@Tree.$(n)'>
	            <metadata spec='snap.RateToTheta' id='theta' coalescenceRate='@coalescenceRate'/>
	        </log>
		</logger>

]]>

            <connect spec='BeautiConnector' srcID='NodeSwapper' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='NodeBudger' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='TreeScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='GammaMover' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='RateMixer' targetID='mcmc' inputName='operator'/>


            <connect spec='BeautiConnector' srcID='uScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='vScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='alphaScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='betaScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='lambdaScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='kappaScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='mutationRateScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='propInvariantScaler' targetID='mcmc' inputName='operator'/>
            <connect spec='BeautiConnector' srcID='gammaShapeScaler' targetID='mcmc' inputName='operator'/>

            <connect spec='BeautiConnector' srcID='treelog' targetID='mcmc' inputName='logger'/>

            <connect spec='BeautiConnector' srcID='u' targetID='tracelog' inputName='log'/>
            <connect spec='BeautiConnector' srcID='v' targetID='tracelog' inputName='log'/>
            <connect spec='BeautiConnector' srcID='coalescenceRate' targetID='tracelog' inputName='log'/>
            <connect spec='BeautiConnector' srcID='ThetaLogger' targetID='tracelog' inputName='log'/>
            <connect spec='BeautiConnector' srcID='TreeHeightLogger' targetID='tracelog' inputName='log'/>

            <connect spec='BeautiConnector' srcID='snapprior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='alphaPrior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='betaPrior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='lambdaPrior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='kappaPrior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='uPrior.$(n)' targetID='prior' inputName='distribution'/>
            <connect spec='BeautiConnector' srcID='vPrior.$(n)' targetID='prior' inputName='distribution'/>

            <connect spec='BeautiConnector' srcID='treeLikelihood.$(n)' targetID='likelihood' inputName='distribution'/>
        </partitiontemplate>




        <mergepoint id='commonTemplates'/>

<!-- Tree initialisation -->
<!-- Random tree -->

        <subtemplate id='RandomTree' spec='BeautiSubTemplate' class='beast.evolution.tree.RandomTree' mainid='RandomTree.$(n)'>
<![CDATA[
            <tree spec='beast.evolution.tree.RandomTree' id='RandomTree.$(n)' estimate='false' trait='@datetrait.$(n)'>
                <taxa spec='Alignment' idref='data'/>
                <populationModel id='ConstantPopulation.$(n)' spec='ConstantPopulation'>
            		<popSize id='popSize.$(n)' spec='parameter.RealParameter' value='1'/>
	            </populationModel>
            </tree>
]]>
        </subtemplate>

<!-- Cluster tree (for UPGMA) -->

        <subtemplate id='UPGMATree' spec='BeautiSubTemplate' class='beast.util.ClusterTree' mainid='UPGMATree.$(n)'>
<![CDATA[
        <tree spec='beast.util.ClusterTree' id='UPGMATree.$(n)' clusterType='upgma' estimate='false'  trait='@datetrait.$(n)' taxa='@$(n)'/>
]]>
        </subtemplate>

<!-- Newick tree -->
        <subtemplate id='NewickTree' spec='BeautiSubTemplate' class='beast.util.ClusterTree' mainid='NewickTree.$(n)'>
<![CDATA[
        <tree spec='beast.util.TreeParser' id='NewickTree.$(n)' estimate='false'  trait='@datetrait.$(n)'  taxa='@$(n)' newick=""/>
]]>
        </subtemplate>

<!-- Uniform -->
        <subtemplate id='Uniform' spec='BeautiSubTemplate' class='beast.math.distributions.Uniform' mainid='[top]'>
<![CDATA[
        <distr spec="beast.math.distributions.Uniform" lower='0' upper='Infinity'/>
]]>
        </subtemplate>

<!-- Normal -->
        <subtemplate id='Normal' spec='BeautiSubTemplate' class='beast.math.distributions.Normal' mainid='[top]'>
<![CDATA[
    <distr offset="0.0" spec="beast.math.distributions.Normal">
        <parameter name='mean' value='0' estimate='false'/>
        <parameter name='sigma' value='1' estimate='false'/>
    </distr>
]]>
        </subtemplate>

<!-- OneOnX -->
        <subtemplate id='1/X' spec='BeautiSubTemplate' class='beast.math.distributions.OneOnX' mainid='[top]'>
<![CDATA[
        <distr spec="beast.math.distributions.OneOnX"/>
]]>
        </subtemplate>

<!-- lognormal -->
        <subtemplate id='LogNormal' spec='BeautiSubTemplate' class='beast.math.distributions.LogNormalDistributionModel' mainid='[top]'>
<![CDATA[
        <distr name='distr' spec="beast.math.distributions.LogNormalDistributionModel">
            <parameter name='M' value="1" estimate='false'/>
            <parameter name='S' value="1.25" lower="0" upper="5" estimate='false'/>
        </distr>
]]>
        </subtemplate>

<!-- Exponential -->
        <subtemplate id='Exponential' spec='BeautiSubTemplate' class='beast.math.distributions.Exponential' mainid='[top]'>
<![CDATA[
        <distr offset="0.0" spec="beast.math.distributions.Exponential">
            <parameter name='lambda' value="1" estimate='false'/>
        </distr>
]]>
        </subtemplate>

<!-- Gamma -->
        <subtemplate id='Gamma' spec='BeautiSubTemplate' class='beast.math.distributions.Gamma' mainid='[top]'>
<![CDATA[
        <distr offset="0.0" spec="beast.math.distributions.Gamma">
            <parameter name='alpha' value="2" estimate='false'/>
            <parameter name='beta' value="2" estimate='false'/>
        </distr>
]]>
        </subtemplate>

<!-- Laplace -->
<!-- TODO: IMPLEMENT beast.math.distributions.LaplaceDistribution.getDistribution() before uncommenting this
        <subtemplate id='LaplaceDistribution' spec='BeautiSubTemplate' class='beast.math.distributions.LaplaceDistribution' mainid='[top]'>
<![CDATA[
        <distr offset="0.0" spec="beast.math.distributions.LaplaceDistribution">
            <parameter name='mu' value="0" estimate='false'/>
            <parameter name='scale' value="1" estimate='false'/>
        </distr>
]]>
        </subtemplate>
-->

<!-- InverseGamma -->
        <subtemplate id='InverseGamma' spec='BeautiSubTemplate' class='beast.math.distributions.InverseGamma' mainid='[top]'>
<![CDATA[
        <distr offset="0.0" spec="beast.math.distributions.InverseGamma">
            <parameter name='alpha' value="2" estimate='false'/>
            <parameter name='beta' value="2" estimate='false'/>
        </distr>
]]>
        </subtemplate>
    </beauticonfig>








<!-- framework for main model -->

    <run spec="MCMC" id="mcmc" chainLength="10000000">

        <state storeEvery='100000' id='state'>
        </state>

        <distribution spec="CompoundDistribution" id="posterior">
            <distribution spec="CompoundDistribution" id="prior">
            </distribution>
            <distribution spec="CompoundDistribution" id="likelihood">
            </distribution>
        </distribution>

        <stateDistribution idref='prior'/>


        <logger id='tracelog' logEvery="10000" fileName="snap.$(seed).log">
	        <model idref='posterior'/>
            <log idref="posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
        </logger>

        <logger id='screenlog' logEvery="10000">
	        <!--model idref='posterior'/-->
            <log idref="posterior"/>
      	    <ESS spec='ESS' name='log' arg="@posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
        </logger>
    </run>

</beast>

